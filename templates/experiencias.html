<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Experiencias</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://js.pusher.com/7.0/pusher.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<div class="container">
    <h1 class="mt-5">Registro de Experiencias</h1>
    
    <!-- Formulario para registrar una nueva experiencia -->
    <form id="formRegistrar">
        <div class="form-group">
            <input type="text" id="txtNombreApellido" name="txtNombreApellido" class="form-control" placeholder="Nombre y Apellido" required>
        </div>
        <div class="form-group">
            <textarea id="txtComentario" name="txtComentario" class="form-control" placeholder="Comentario" required></textarea>
        </div>
        <div class="form-group">
            <input type="number" id="txtCalificacion" name="txtCalificacion" class="form-control" placeholder="Calificación" required>
        </div>
        <button type="submit" class="btn btn-primary">Registrar</button>
    </form>

    <!-- Tabla de experiencias -->
    <h2 class="mt-5">Experiencias Registradas</h2>
    <table id="tablaExperiencias" class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Nombre y Apellido</th>
                <th>Comentario</th>
                <th>Calificación</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            <!-- Aquí se cargarán las experiencias -->
        </tbody>
    </table>
</div>

<script>
    // Configurar Pusher
    Pusher.logToConsole = true;
    var pusher = new Pusher("2df86616075904231311", {
        cluster: "us2" // Cambia a tu clúster correcto
    });

    var channel = pusher.subscribe("canalRegistrosexperiencias");
    channel.bind("registroexperiencias", function(data) {
        buscar(); // Cargar experiencias cuando hay un nuevo registro
    });

    // Función para buscar experiencias
    function buscar() {
        $.ajax({
            url: "/buscar",
            method: "GET",
            success: function (registros) {
                let tabla = '';
                registros.forEach(function (exp) {
                    tabla += `<tr>
                        <td>${exp[0]}</td>
                        <td>${exp[1]}</td>
                        <td>${exp[2]}</td>
                        <td>${exp[3]}</td>
                        <td>
                            <button class="btn btn-danger" onclick="eliminarExperiencia(${exp[0]})">Eliminar</button>
                            <button class="btn btn-warning" onclick="editarExperiencia(${exp[0]}, '${exp[1]}', '${exp[2]}', ${exp[3]})">Editar</button>
                        </td>
                    </tr>`;
                });
                $("#tablaExperiencias tbody").html(tabla);
            }
        });
    }

    // Función para eliminar experiencia
    function eliminarExperiencia(id) {
        if (confirm("¿Estás seguro de que deseas eliminar esta experiencia?")) {
            // Cambiar la URL sin recargar la página
            window.history.pushState({}, '', `?eliminar/id=${id}`);

            $.ajax({
                url: `/experiencia/eliminar/${id}`,
                method: "DELETE",
                success: function (respuesta) {
                    alert("Experiencia eliminada");
                    buscar();
                }
            });
        }
    }

    // Función para editar experiencia
    function editarExperiencia(id, nombreApellido, comentario, calificacion) {
        // Cambiar la URL sin recargar la página
        window.history.pushState({}, '', `?editar/id=${id}`);

        let nuevoNombreApellido = prompt("Ingresa el nuevo nombre y apellido:", nombreApellido);
        let nuevoComentario = prompt("Ingresa el nuevo comentario:", comentario);
        let nuevaCalificacion = prompt("Ingresa la nueva calificación:", calificacion);

        if (nuevoNombreApellido && nuevoComentario && nuevaCalificacion) {
            $.ajax({
                url: `/experiencia/actualizar/${id}`,
                method: "PUT",
                data: {
                    nombre_apellido: nuevoNombreApellido,
                    comentario: nuevoComentario,
                    calificacion: nuevaCalificacion
                },
                success: function (respuesta) {
                    alert("Experiencia actualizada");
                    buscar();
                }
            });
        }
    }

    // Función para registrar experiencia
    $("#formRegistrar").submit(function (event) {
        event.preventDefault();
        $.ajax({
            url: "/registrar",
            method: "POST",
            data: $(this).serialize(),
            success: function (respuesta) {
                alert(respuesta.message);
                buscar();
            }
        });
    });

    // Inicializar la tabla
    buscar();
</script>

</body>
</html>
