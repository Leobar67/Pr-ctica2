<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Experiencias</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://js.pusher.com/7.0/pusher.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Experiencias</h1>
        <form method="post" id="frmexperiencias" class="formulario">
            <div class="mb-1">
                <label for="txtNombreApellido">Nombre y Apellido:</label>
                <input type="text" name="txtNombreApellido" id="txtNombreApellido" class="form-control" required minlength="8" maxlength="25">
            </div>
            <div class="mb-1">
                <label for="txtComentario">Comentario:</label>
                <input type="text" name="txtComentario" id="txtComentario" class="form-control" required minlength="6" maxlength="255">
            </div>
            <div class="mb-1">
                <label for="txtCalificacion">Calificación:</label>
                <input type="number" name="txtCalificacion" id="txtCalificacion" class="form-control" required>
            </div>
            <input type="hidden" name="id_experiencia" id="id_experiencia">
            <div class="text-end">
                <button id="btnGuardarFA" name="btnGuardarFA" class="btn btn-dark">Guardar</button>
            </div>
        </form>

        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Nombre y Apellido</th>
                    <th>Comentario</th>
                    <th>Calificación</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tbodyexperiencias"></tbody>
        </table>
    </div>

    <script>
        // Inicialización de Pusher
        var pusher = new Pusher('2df86616075904231311', {
            cluster: 'us2'
        });
        var channel = pusher.subscribe('canalRegistrosexperiencias');

        channel.bind('registroexperiencias', function(data) {
            alert('Nueva experiencia registrada: ' + data.Nombre_Apellido);
            buscar(); // Actualiza la lista de experiencias
        });

        channel.bind('eliminarexperiencia', function(data) {
            alert('Experiencia eliminada con ID: ' + data.Id_Experiencia);
            buscar(); // Actualiza la lista de experiencias
        });

        window.addEventListener("load", function (event) {
            function buscar() {
                $.get("/buscar", function (respuesta) {
                    $("#tbodyexperiencias").html("")
                    for (var x in respuesta) {
                        var experiencia = respuesta[x]
                        $("#tbodyexperiencias").append(`<tr>
                            <td>${experiencia[1]}</td>
                            <td>${experiencia[2]}</td>
                            <td>${experiencia[3]}</td>
                            <td>
                                <button onclick="editarExperiencia(${experiencia[0]})" class="btn btn-warning btn-sm">Editar</button>
                                <button onclick="eliminarExperiencia(${experiencia[0]})" class="btn btn-danger btn-sm">Eliminar</button>
                            </td>
                        </tr>`)
                    }
                })
            }

            function editarExperiencia(id) {
                $.get(`/experiencia/${id}`, function (experiencia) {
                    $("#txtNombreApellido").val(experiencia.Nombre_Apellido)
                    $("#txtComentario").val(experiencia.Comentario)
                    $("#txtCalificacion").val(experiencia.Calificacion)
                    $("#id_experiencia").val(experiencia.Id_Experiencia)
                })
            }

            function eliminarExperiencia(id) {
                $.post(`/eliminar/${id}`, function (respuesta) {
                    alert(respuesta.message)
                    buscar()
                })
            }

            buscar()

            // Enviar formulario para registrar o actualizar experiencia
            $("#frmexperiencias").submit(function (event) {
                event.preventDefault()
                if ($("#id_experiencia").val()) {
                    $.post("/actualizar", $(this).serialize(), function (respuesta) {
                        alert(respuesta.message)
                        buscar()
                    })
                } else {
                    $.post("/registrar", $(this).serialize(), function (respuesta) {
                        alert(respuesta.message)
                        buscar()
                    })
                }
            })
        })
    </script>
</body>
</html>
