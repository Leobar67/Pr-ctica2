<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Experiencias</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <script src="https://js.pusher.com/7.0/pusher.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>Registrar Nueva Experiencia</h1>
        <form id="frmexperiencias">
            <div class="mb-3">
                <label for="txtNombreApellido" class="form-label">Nombre y Apellido</label>
                <input type="text" class="form-control" id="txtNombreApellido" name="txtNombreApellido" required>
            </div>
            <div class="mb-3">
                <label for="txtComentario" class="form-label">Comentario</label>
                <textarea class="form-control" id="txtComentario" name="txtComentario" required></textarea>
            </div>
            <div class="mb-3">
                <label for="txtCalificacion" class="form-label">Calificación</label>
                <input type="number" class="form-control" id="txtCalificacion" name="txtCalificacion" required>
            </div>
            <button type="submit" class="btn btn-primary">Registrar</button>
        </form>

        <h2 class="mt-5">Experiencias Registradas</h2>
        <table class="table table-bordered mt-3">
            <thead>
                <tr>
                    <th>Nombre y Apellido</th>
                    <th>Comentario</th>
                    <th>Calificación</th>
                </tr>
            </thead>
            <tbody id="tablaExperiencias">
                <!-- Las experiencias se mostrarán aquí -->
            </tbody>
        </table>
    </div>

    <script>
        // Validación del formulario
        $("#frmexperiencias").validate({
            messages: {
                txtNombreApellido: {
                    required: "Ingresa tu Nombre y Apellido",
                    minlength: "Ingresa al menos 8 letras",
                    maxlength: "Ingresa menos de 25 letras"
                },
                txtComentario: {
                    required: "Ingresa una reseña positiva",
                    minlength: "Ingresa al menos 6 caracteres",
                    maxlength: "Ingresa menos de 25 caracteres"
                },
                txtCalificacion: {
                    required: "Ingresa una calificación",
                    digits: "La calificación debe ser un número"
                }
            },
            rules: {
                txtNombreApellido: {
                    required: true,
                    minlength: 8,
                    maxlength: 25
                },
                txtComentario: {
                    required: true,
                    minlength: 6,
                    maxlength: 25
                },
                txtCalificacion: {
                    required: true,
                    digits: true
                }
            }
        });

        // Inicialización de Pusher
        var pusher = new Pusher("2df86616075904231311", {
            cluster: "eu" // Actualizado al clúster correcto
        });

        var channel = pusher.subscribe("canalRegistrosexperiencias");
        channel.bind("registroexperiencias", function(data) {
            // Asegúrate de que las claves de data coincidan con las del objeto enviado desde el servidor
            if (data.Nombre_Apellido && data.Comentario && data.Calificacion) {
                $("#tablaExperiencias").prepend(`
                    <tr>
                        <td>${data.Nombre_Apellido}</td>
                        <td>${data.Comentario}</td>
                        <td>${data.Calificacion}</td>
                    </tr>
                `);
            }
        });

        // Envío del formulario con AJAX
        $("#frmexperiencias").on("submit", function(e) {
            e.preventDefault();

            if ($(this).valid()) {
                let nombreApellido = $("#txtNombreApellido").val();
                let comentario = $("#txtComentario").val();
                let calificacion = $("#txtCalificacion").val();

                $.ajax({
                    url: "/registrar",
                    method: "POST",
                    data: {
                        txtNombreApellido: nombreApellido,
                        txtComentario: comentario,
                        txtCalificacion: calificacion
                    },
                    success: function(response) {
                        alert("Experiencia registrada correctamente");
                        // Limpia el formulario tras registrar
                        $("#frmexperiencias")[0].reset();
                    },
                    error: function(err) {
                        alert("Error al registrar la experiencia");
                    }
                });
            }
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
