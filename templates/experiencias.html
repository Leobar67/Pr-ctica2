<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>

    <title>Experiencias</title>
</head>
<body>
    <div class="container">
        <form method="post" id="frmexperiencias" class="formulario">
            <div class="mb-1">
                <label for="txtNombreApellido">Nombre y Apellido:</label>
                <input type="text" name="txtNombreApellido" id="txtNombreApellido" class="form-control" required minlength="8" maxlength="25">
            </div>
            <div class="mb-1">
                <label for="txtComentario">Comentario:</label>
                <input type="text" name="txtComentario" id="txtComentario" class="form-control" required minlength="6" maxlength="25">
            </div>
            <div class="mb-1">
                <label for="txtCalificacion">Calificación:</label>
                <input type="number" name="txtCalificacion" id="txtCalificacion" class="form-control" required>
            </div>
            <div class="text-end">
                <button id="btnGuardarFA" name="btnGuardarFA" class="btn btn-dark">Guardar</button>
            </div>
        </form>

        <div id="divexperiencias"></div>
    
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>Nombre y Apellido</th>
                    <th>Comentario</th>
                    <th>Calificación</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tbodyexperiencias"></tbody>
        </table>
    </div>

    <script>
        window.addEventListener("load", function (event) {
            // Formulario de validación
            $("#frmexperiencias").validate();

            // Subida de la experiencia
            $("#frmexperiencias").submit(function (event) {
                event.preventDefault();

                $.post("/registrar", $(this).serialize(), function (respuesta) {
                    console.log(respuesta);
                });
            });

            // Buscar y mostrar las experiencias
            function buscar() {
                $.get("/buscar", { timestamp: new Date().getTime() }, function (respuesta) {
                    $("#tbodyexperiencias").html("");
                    for (var x in respuesta) {
                        var experiencia = respuesta[x];
                        $("#tbodyexperiencias").append(`<tr>
                            <td>${experiencia[1]}</td>
                            <td>${experiencia[2]}</td>
                            <td>${experiencia[3]}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="editarExperiencia(${experiencia[0]})">Editar</button>
                                <button class="btn btn-danger btn-sm" onclick="eliminarExperiencia(${experiencia[0]})">Eliminar</button>
                            </td>
                        </tr>`);
                    }
                });
            }

            buscar();

            // Pusher para actualizaciones en tiempo real
            Pusher.logToConsole = true;
            var pusher = new Pusher("2df86616075904231311", {
                cluster: "us2"
            });

            var channel = pusher.subscribe("canalRegistrosexperiencias");
            channel.bind("registroexperiencias", function (experiencias) {
                buscar();
            });
        });

        // Función para eliminar experiencia
        function eliminarExperiencia(id) {
            if (confirm("¿Estás seguro de que deseas eliminar esta experiencia?")) {
                $.ajax({
                    url: `/experiencia/eliminar/${id}`,
                    method: "DELETE",
                    success: function (respuesta) {
                        alert("Experiencia eliminada");
                        buscar();
                    }
                });
            }
        }

        // Función para editar experiencia
        function editarExperiencia(id) {
            let nuevoComentario = prompt("Ingresa el nuevo comentario:");
            let nuevaCalificacion = prompt("Ingresa la nueva calificación:");

            if (nuevoComentario && nuevaCalificacion) {
                $.ajax({
                    url: `/experiencia/actualizar/${id}`,
                    method: "PUT",
                    data: {
                        comentario: nuevoComentario,
                        calificacion: nuevaCalificacion
                    },
                    success: function (respuesta) {
                        alert("Experiencia actualizada");
                        buscar();
                    }
                });
            }
        }
    </script>
</body>
</html>
